@namespace Blazor.Sonner
@implements IDisposable
@inject DomInterop DomInterop
@inject ToastService ToastService

<CascadingValue TValue="Toaster" Value="@this" IsFixed="@true">
    <section tabindex="-1"
             aria-label="Notifications"
             aria-live="polite"
             aria-relevant="additions text"
             aria-atomic="false">
        @if( FilteredToasts?.Count > 0 )
        {
            for( var posIndex = 0; posIndex < PossiblePositions?.Count; posIndex++ )
            {
                var position = PossiblePositions[posIndex];
                var (y, x) = Utils.MapPosition( position );

                <ol @key="@position"
                    dir="@_dir.ToString().ToLowerInvariant()"
                    style="--gap: @($"{Gap}px"); --width: @($"{Constants.ToastWidth}px"); @Utils.GetOffset( Offset, MobileOffset )
                                                   --front-toast-height: @FrontToastHeight;"
                    tabindex="-1"
                    data-sonner-toaster
                    data-sonner-theme="light"
                    data-y-position="@y"
                    data-x-position="@x"
                    @onmouseenter="@(() => Expanded = true)"
                    @onmousemove="@(() => Expanded = true)"
                    @onmouseleave="@(() => Expanded = false)">
                    @for( var index = 0; index < FilteredToasts.Count; index++ )
                    {
                        var toast = FilteredToasts[index];

                        if( (!toast.Position.HasValue && posIndex == 0) || toast.Position == position )
                        {
                            <Toast @key="@toast.Id"
                                   Index="@index"
                                   Model="@toast"
                                   Position="@position"
                                   OnDismiss="@RemoveToast"
                                   OnDismissing="@RemoveToastHeight"
                                   OnHeightChanged="@SaveToastHeight" />
                        }
                    }
                </ol>
            }
        }
    </section>
</CascadingValue>

@code {
    [Parameter] public string? Id { get; set; }
    [Parameter] public Position Position { get; set; } = Position.BottomRight;
    [Parameter] public Offset? Offset { get; set; }
    [Parameter] public Offset? MobileOffset { get; set; }
    [Parameter] public int VisibleToasts { get; set; } = Constants.VisibleToastsAmount;
    [Parameter] public int Gap { get; set; } = Constants.Gap;
    [Parameter] public TimeSpan Duration { get; set; } = TimeSpan.FromMilliseconds( Constants.ToastLifetime );
    [Parameter] public bool CloseButton { get; set; }
    [Parameter] public bool RichColors { get; set; }
    [Parameter] public DocumentDirection Dir { get; set; } = DocumentDirection.Auto;

    internal bool Expanded { get; private set; }
    internal List<Height> ToastHeights { get; } = [];

    internal List<ToastModel> FilteredToasts =>
        !string.IsNullOrWhiteSpace( Id )
            ? _toasts.Where( t => t.ToasterId == Id ).ToList()
            : _toasts.Where( t => string.IsNullOrWhiteSpace( t.ToasterId ) ).ToList();

    private List<Position> PossiblePositions => FilteredToasts
        .Where( t => t.Position.HasValue )
        .Select( t => t.Position!.Value )
        .Prepend( Position )
        .Distinct()
        .ToList();

    private string FrontToastHeight => ToastHeights.Count > 0
        ? $"{ToastHeights[0].Value.ToString( CultureInfo.InvariantCulture )}px"
        : "0px";

    private readonly List<ToastModel> _toasts = [];

    private DocumentDirection _dir;

    protected override void OnInitialized()
    {
        ToastService.OnShow += ShowToast;
    }

    protected override async Task OnAfterRenderAsync( bool firstRender )
    {
        _dir = Dir switch
        {
            DocumentDirection.Auto => await DomInterop.GetDocumentDirectionAsync(),
            _ => Dir
        };

        // Ensure expanded is always false when no toasts are present / only one left
        if( _toasts.Count <= 1 )
        {
            Expanded = false;
        }
    }

    private void ShowToast( object? sender, ToastModel toast )
    {
        _toasts.Insert( 0, toast );
        StateHasChanged();
    }

    private void RemoveToast( Guid id )
    {
        _toasts.RemoveAll( x => x.Id == id );
    }

    private void RemoveToastHeight( Guid id )
    {
        ToastHeights.RemoveAll( x => x.ToastId == id );
    }

    private void SaveToastHeight( Height height )
    {
        ToastHeights.Insert( 0, height );
    }

    void IDisposable.Dispose()
    {
        ToastService.OnShow -= ShowToast;
    }
}
